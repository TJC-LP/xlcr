# Dockerfile.agent
# Builds an XLCR assembly JAR and runs the GraalVM tracing agent
# to capture native-image metadata for all conversion paths.
#
# This does NOT build a native image — it only produces metadata.
# Use Dockerfile.native (or `make docker-native`) to build the actual binary.
#
# Usage:
#   make docker-native-agent
#
# Or manually:
#   docker build -f Dockerfile.agent -t xlcr-agent-builder .
#   docker run --name xlcr-agent-run xlcr-agent-builder
#   docker cp xlcr-agent-run:/metadata-output/ ./metadata-output/
#   docker rm xlcr-agent-run

FROM ubuntu:24.04

# Install build tools and Python (no JDK from apt — we use GraalVM below)
RUN apt-get update && apt-get install -y \
    curl \
    make \
    build-essential \
    zlib1g-dev \
    python3 \
    python3-pip \
    && pip3 install --break-system-packages openpyxl \
    && rm -rf /var/lib/apt/lists/*

# Install GraalVM CE as the system JDK (matches jvmId in package.mill)
ARG GRAALVM_VERSION=25.0.2
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "arm64" ]; then GRAAL_ARCH="aarch64"; else GRAAL_ARCH="x64"; fi && \
    curl -fL "https://github.com/graalvm/graalvm-ce-builds/releases/download/jdk-${GRAALVM_VERSION}/graalvm-community-jdk-${GRAALVM_VERSION}_linux-${GRAAL_ARCH}_bin.tar.gz" \
      | tar xz -C /opt && \
    ln -s /opt/graalvm-community-openjdk-* /opt/graalvm

ENV JAVA_HOME=/opt/graalvm
ENV PATH="${JAVA_HOME}/bin:${PATH}"

# Install Mill (same version as .mill-version)
ARG MILL_VERSION=1.1.2
RUN curl -fLo /usr/local/bin/mill \
      "https://repo1.maven.org/maven2/com/lihaoyi/mill-dist/${MILL_VERSION}/mill-dist-${MILL_VERSION}-mill.sh" && \
    chmod +x /usr/local/bin/mill

WORKDIR /xlcr

# Copy build definitions first for better layer caching
COPY build.mill .mill-version .mill-jvm-opts .scalafmt.conf ./
COPY mill ./
COPY core/package.mill core/package.mill
COPY core-aspose/package.mill core-aspose/package.mill
COPY core-libreoffice/package.mill core-libreoffice/package.mill
COPY core-spark/package.mill core-spark/package.mill
COPY xlcr/package.mill xlcr/package.mill
COPY server/package.mill server/package.mill

# Copy source code and resources
COPY core/src core/src
COPY core-aspose/src core-aspose/src
COPY core-aspose/resources core-aspose/resources
COPY core-libreoffice/src core-libreoffice/src
COPY xlcr/src xlcr/src

# Copy Aspose license if available (glob trick: no-op if missing)
COPY Aspose.Java.Total.li[c] core-aspose/resources/

# Build assembly JAR (much faster than native image)
RUN mill 'xlcr[3.3.4].assembly'

# Download GraalVM (needed for tracing agent library)
RUN mill 'xlcr[3.3.4].nativeImageTool'

# Copy test fixtures and runner script
COPY scripts/testdata/test.html /xlcr/testdata/test.html
COPY scripts/testdata/gen-test-xlsx.py /xlcr/testdata/gen-test-xlsx.py
RUN python3 /xlcr/testdata/gen-test-xlsx.py /xlcr/testdata/test.xlsx
COPY scripts/run-native-agent.sh /xlcr/run-native-agent.sh
RUN chmod +x /xlcr/run-native-agent.sh

# Create metadata output directory
RUN mkdir -p /metadata-output

ENTRYPOINT ["/xlcr/run-native-agent.sh"]
